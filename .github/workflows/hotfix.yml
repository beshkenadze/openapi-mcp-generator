name: Hotfix Workflow

on:
  push:
    branches:
      - "hotfix/**"
  workflow_dispatch:
    inputs:
      hotfix_branch:
        description: "Hotfix branch name (e.g., hotfix/v1.2.1)"
        required: true
      emergency:
        description: "Emergency hotfix (skip some checks)"
        type: boolean
        default: false

jobs:
  hotfix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Check for existing changesets
        id: check-changesets
        run: |
          if find .changeset -name "*.md" -not -name "README.md" -not -name "config.json" | grep -q .; then
            echo "has-changesets=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ Found existing changesets"
          else
            echo "has-changesets=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No changesets found - will create emergency changeset"
          fi

      - name: Create emergency changeset
        if: steps.check-changesets.outputs.has-changesets == 'false'
        run: |
          echo "ğŸš¨ Creating emergency changeset for hotfix..."

          # Extract issue/description from branch name or commit message
          BRANCH_NAME="${{ github.ref_name }}"
          HOTFIX_NAME=${BRANCH_NAME#hotfix/}

          # Create changeset content
          cat > .changeset/emergency-hotfix-$(date +%s).md << EOF
          ---
          "@aigentools/mcpgen-core": patch
          "@aigentools/mcpgen": patch
          ---

          Emergency hotfix: $HOTFIX_NAME

          This hotfix addresses a critical issue that requires immediate attention.
          EOF

          echo "âœ… Emergency changeset created"

      - name: Run essential checks
        if: github.event.inputs.emergency != 'true'
        run: |
          echo "ğŸ§ª Running essential checks..."
          bun run build
          bun run typecheck
          # Skip lint and full test suite for emergency hotfixes

      - name: Version packages
        run: |
          echo "ğŸ”„ Processing changesets and updating versions..."
          bun changeset version

          # Configure git for commits
          git config user.name "hotfix-bot[bot]"
          git config user.email "hotfix-bot[bot]@users.noreply.github.com"

          # Commit version changes
          git add .
          git commit -m "hotfix: version packages for ${{ github.ref_name }} [skip ci]" || echo "No changes to commit"

      - name: Build and test hotfix
        if: github.event.inputs.emergency != 'true'
        run: |
          echo "ğŸ—ï¸ Building packages..."
          bun run build

          echo "ğŸ§ª Running critical tests..."
          bun run test || echo "âš ï¸ Some tests failed but continuing with hotfix"
        env:
          NODE_ENV: test

      - name: Publish hotfix
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "ğŸš€ Publishing hotfix packages..."

          # Configure npm authentication
          echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc

          # Publish packages
          bun changeset publish

          echo "âœ… Hotfix packages published successfully!"

      - name: Push tags
        run: |
          echo "ğŸ·ï¸ Pushing git tags..."
          git push origin ${{ github.ref_name }}
          git push --follow-tags

      - name: Extract version from branch name
        id: version
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          VERSION=${BRANCH_NAME#hotfix/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ·ï¸ Extracted version: $VERSION"

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.version }}
          release_name: "ğŸš¨ Hotfix ${{ steps.version.outputs.version }}"
          body: |
            ## ğŸš¨ Emergency Hotfix Release

            This hotfix addresses a critical issue that required immediate attention.

            ### ğŸ”§ Fixed Issues
            - Critical bug fix for production environment
            - Immediate resolution required

            ### ğŸ“¦ Published Packages
            - `@aigentools/mcpgen-core`
            - `@aigentools/mcpgen`

            ### âš ï¸ Important Notes
            - This is a hotfix release created from branch: `${{ github.ref_name }}`
            - Please update your dependencies as soon as possible
            - Full regression testing will be performed in the next regular release

            ### ğŸ› ï¸ Installation
            ```bash
            npm install @aigentools/mcpgen@${{ steps.version.outputs.version }}
            npm install @aigentools/mcpgen-core@${{ steps.version.outputs.version }}
            ```
          draft: false
          prerelease: false

      - name: Create PR to main
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.PAT_TOKEN }}
          branch: ${{ github.ref_name }}
          base: main
          title: "ğŸš¨ Hotfix: ${{ github.ref_name }}"
          body: |
            ## ğŸš¨ Emergency Hotfix

            This hotfix has been automatically published to npm and needs to be merged to main.

            **Hotfix Details:**
            - Branch: `${{ github.ref_name }}`
            - Version: `${{ steps.version.outputs.version }}`
            - Published: âœ… Already published to npm

            **Next Steps:**
            1. âœ… Packages already published
            2. â³ Merge this PR to main
            3. â³ Will automatically create PR to develop

            **âš ï¸ This hotfix was published before merge for emergency response.**
          labels: |
            hotfix
            emergency
            automated

      - name: Create PR to develop
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.PAT_TOKEN }}
          branch: ${{ github.ref_name }}
          base: develop
          title: "ğŸš¨ Hotfix: ${{ github.ref_name }} (to develop)"
          body: |
            ## ğŸš¨ Hotfix Merge to Develop

            This hotfix needs to be merged to develop to keep branches in sync.

            **Hotfix Details:**
            - Branch: `${{ github.ref_name }}`
            - Version: `${{ steps.version.outputs.version }}`
            - Published: âœ… Already published to npm
            - Main PR: Will be created separately

            **This ensures develop branch includes the hotfix changes.**
          labels: |
            hotfix
            emergency
            automated

      - name: Hotfix summary
        run: |
          echo "ğŸ‰ Hotfix ${{ steps.version.outputs.version }} completed!"
          echo ""
          echo "âœ… Packages published to npm"
          echo "âœ… Git tags created and pushed"
          echo "âœ… GitHub release created"
          echo "âœ… PR to main created"
          echo "âœ… PR to develop created"
          echo ""
          echo "âš ï¸ IMPORTANT: Merge the PRs to keep branches synchronized"
          echo ""
          echo "ğŸ”— View the release: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
